<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>HandTrack Pro — жестовое управление</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<meta name="color-scheme" content="dark light" />
<style>
  :root{ --bg:#0b111b; --panel:#0f1520; --line:#ffffff22; --txt:#e8eef7; --acc:#86c9ff; --ok:#6ee7a8; --warn:#ffd479; }
  *{ box-sizing:border-box }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--txt);
    font:14px/1.35 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif }
  #app{ position:fixed; inset:0; overflow:hidden }
  canvas#view{ position:absolute; inset:0; width:100%; height:100%; display:block;
    background:radial-gradient(1100px 700px at 50% 40%, #0c1627, #0b111b) }

  /* UI */
  #ui{ position:absolute; left:12px; right:12px; top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;
       z-index:30; background:#0d1421cc; border:1px solid var(--line); border-radius:14px; padding:10px; backdrop-filter:blur(8px) }
  .btn, select, input[type=range]{ appearance:none; border:1px solid var(--line); background:#ffffff12; color:var(--txt);
       padding:8px 12px; border-radius:12px; font-weight:700; cursor:pointer }
  .btn:active{ transform:translateY(1px) }
  label{ display:flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--line); border-radius:12px; background:#ffffff10 }
  #status{ margin-left:auto; font-size:12px; opacity:.9 }

  /* Splash */
  #splash{ position:absolute; inset:0; display:grid; place-items:center; z-index:50;
    background:radial-gradient(900px 640px at 50% 30%, #ffffff12, #00000088 60%, #000) }
  .logo{ text-align:center }
  .made{ font-size:13px; letter-spacing:.22em; opacity:.72 }
  .name{ font-size:42px; font-weight:900; letter-spacing:.02em;
         background:linear-gradient(90deg,#78b6ff,#baf0ff,#78b6ff);
         -webkit-background-clip:text; background-clip:text; color:transparent;
         filter:drop-shadow(0 8px 32px #66aaff30); animation:shine 3s ease-in-out infinite }
  .sub{ margin-top:6px; opacity:.9 }
  .start{ margin-top:18px; padding:12px 18px; font-size:16px; border-radius:14px; border:1px solid #6dbaff80; background:#6dbaff20; cursor:pointer }
  @keyframes shine{ 0%,100%{letter-spacing:.02em} 50%{letter-spacing:.06em} }
  .fade-out{ animation:fadeout .6s ease forwards } @keyframes fadeout{ to{ opacity:0; visibility:hidden } }

  /* Debug + cursor */
  #video,#dbg{ position:absolute; right:12px; bottom:12px; width:240px; height:auto; border-radius:12px; border:1px solid var(--line); display:none; z-index:40; background:#000 }
  #dbg{ right:264px }
  #diag{ position:fixed; left:12px; right:12px; top:12px; z-index:9999; padding:10px 12px; border-radius:12px;
         background:#2a0b0b; color:#ffd9d9; border:1px solid #ff6b6b; font:600 13px/1.3 system-ui; white-space:pre-wrap; display:none }
  #cursor{ position:absolute; width:24px; height:24px; border-radius:50%; border:2px solid var(--acc);
           box-shadow:0 0 18px #86c9ff60; pointer-events:none; z-index:35; transform:translate(-50%,-50%) }
  #cursor.pinching{ background:var(--acc) }
  .ripple{ position:absolute; pointer-events:none; width:12px; height:12px; border-radius:999px; border:2px solid var(--acc); opacity:.9;
           transform:translate(-50%,-50%); animation:rip .5s ease-out both; z-index:34 }
  @keyframes rip{ from{ opacity:1; width:6px; height:6px } to{ opacity:0; width:80px; height:80px } }

  /* FPS pill + log */
  #fps{ position:absolute; left:12px; bottom:12px; z-index:40; font:600 12px system-ui; opacity:.85;
        background:#0d1421cc; border:1px solid var(--line); padding:6px 8px; border-radius:10px }
  #log{ position:absolute; right:12px; top:12px; width:min(420px, 90vw); max-height:42vh; overflow:auto;
        font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0d1421cc;
        border:1px solid var(--line); border-radius:12px; padding:8px 10px; white-space:pre-wrap; z-index:60 }
  #log b{ color:#bff }
  @media (max-width:720px){ .name{font-size:30px} #video,#dbg{display:none!important} #log{display:none} }
</style>
</head>
<body>
<div id="app">
  <canvas id="view"></canvas>

  <div id="ui" hidden>
    <button id="btnBack" class="btn">⟵ Меню</button>
    <button id="btnStart" class="btn">Запустить камеру</button>
    <label>Зеркало X <input type="checkbox" id="mirrorX" checked></label>
    <label>Сглаживание <input id="smooth" type="range" min="0" max="95" value="65"></label>
    <label>Чувств. пинча <input id="pinch" type="range" min="20" max="200" value="90"></label>
    <label>Качество
      <select id="quality">
        <option value="fast" selected>Быстро</option>
        <option value="balanced">Сбаланс.</option>
        <option value="quality">Качество</option>
      </select>
    </label>
    <label><input type="checkbox" id="showDbg"> Отладка</label>
    <div id="status">Готово</div>
  </div>

  <div id="splash">
    <div class="logo">
      <div class="made">СОЗДАНО</div>
      <div class="name">АНДРЕЕМ</div>
      <div class="sub">жест «пинч» = клик. старт неубиваемый</div>
      <a id="startBtn" class="start" href="#go">НАЧАТЬ</a>
      <div id="bootMark" style="margin-top:6px;font-size:12px;opacity:.7">JS не запущен</div>
    </div>
  </div>

  <div id="menu" hidden>
    <div style="display:grid;place-items:center;width:100%;height:100%;opacity:.85">Наведи курсор и щипни, чтобы начать игру</div>
  </div>

  <div id="cursor"></div>
  <div id="fps">render: — fps • track: — fps</div>

  <pre id="log"></pre>

  <video id="video" playsinline muted></video>
  <canvas id="dbg" width="240" height="160"></canvas>
  <div id="diag"></div>
</div>

<script>'use strict'; (function(){const m=document.getElementById('bootMark'); if(m) m.textContent='JS запущен ✓';})();</script>

<script>
'use strict';

/* ===== Elements ===== */
const app = document.getElementById('app');
const canvas = document.getElementById('view');
const ctx = canvas.getContext('2d');
const ui = document.getElementById('ui');
const startBtn = document.getElementById('startBtn');
const splash = document.getElementById('splash');
const menu = document.getElementById('menu');
const btnBack = document.getElementById('btnBack');
const btnStart = document.getElementById('btnStart');
const mirrorX = document.getElementById('mirrorX');
const smoothRange = document.getElementById('smooth');
const pinchRange = document.getElementById('pinch');
const qualitySel = document.getElementById('quality');
const showDbg = document.getElementById('showDbg');
const statusEl = document.getElementById('status');
const video = document.getElementById('video');
const dbg = document.getElementById('dbg');
const dbgCtx = dbg.getContext('2d');
const diag = document.getElementById('diag');
const cursor = document.getElementById('cursor');
const fpsEl = document.getElementById('fps');
const logEl = document.getElementById('log');

/* ===== State ===== */
let W=0,H=0, DPR=Math.min(window.devicePixelRatio||1, 2);
let lastT=performance.now();
let renderFPS=0, trackFPS=0; let rfCount=0, trCount=0, lastRF=performance.now(), lastTR=performance.now();
const pointer = { x:.5, y:.5, rawX:.5, rawY:.5, pinch:false, pinchDown:false, pinchUp:false };
let hands=null, started=false;

/* ===== Utils ===== */
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const lerp=(a,b,t)=>a+(b-a)*t;
function log(m){ logEl.textContent += (m+'\n'); logEl.scrollTop = logEl.scrollHeight; }
function status(m){ statusEl.textContent=m; log('<b>STATUS:</b> '+m); }
function showDiag(msg){ diag.style.display='block'; diag.textContent=msg; log('<b>ERROR:</b> '+msg); }

function resize(){
  W=app.clientWidth; H=app.clientHeight;
  canvas.width=W*DPR; canvas.height=H*DPR; canvas.style.width=W+'px'; canvas.style.height=H+'px';
  ctx.setTransform(DPR,0,0,DPR,0,0);
  log('<b>resize</b>: '+W+'x'+H);
}
window.addEventListener('resize', resize);

/* ===== HUD ===== */
function drawHUD(topText, bottomText){
  ctx.save();
  ctx.fillStyle='#e8eef7';
  ctx.font='16px Inter, system-ui, sans-serif';
  ctx.textBaseline='top';
  ctx.fillText(topText, 16, 16);
  ctx.font='12px Inter, system-ui, sans-serif';
  ctx.textBaseline='bottom';
  ctx.fillText(bottomText, 16, H-16);
  ctx.restore();
}

/* ===== Unstoppable start ===== */
function start(){
  if(started) return; started=true; log('<b>START</b>');
  splash.classList.add('fade-out'); setTimeout(()=>{ splash.hidden=true; }, 550);
  ui.hidden=false; menu.hidden=false; resize(); status('Меню готово');
}
window.addEventListener('load', ()=> setTimeout(start, 300));
startBtn.addEventListener('click', ()=>{ log('<b>click:</b> НАЧАТЬ'); /* hashchange will fire */ });
window.addEventListener('hashchange', ()=>{ if(location.hash==="#go") start(); });
if(location.hash==="#go") start();
['pointerdown','keydown'].forEach(ev=> document.addEventListener(ev, ()=>start(), {once:true,capture:true}));

btnBack.addEventListener('click', ()=>{ menu.hidden=false; log('<b>click:</b> Меню'); });
btnStart.addEventListener('click', startCamera);
showDbg.addEventListener('change', ()=>{ const v=showDbg.checked; video.style.display=dbg.style.display=v?'block':'none'; });

/* ===== Pointer fallback (mouse) ===== */
app.addEventListener('pointermove', (e)=>{
  const r=app.getBoundingClientRect();
  pointer.rawX=(e.clientX-r.left)/r.width; pointer.rawY=(e.clientY-r.top)/r.height;
});
app.addEventListener('pointerdown', ()=>{
  pointer.pinch=true; pointer.pinchDown=true;
  addRipple(pointer.x*W, pointer.y*H);
  setTimeout(()=>{ pointer.pinch=false; pointer.pinchUp=true; }, 120);
});

/* ===== Dynamic loader for MediaPipe (load on button click) ===== */
function loadScript(src){
  return new Promise((res,rej)=>{
    const s=document.createElement('script'); s.src=src; s.async=true;
    s.onload=()=>{ log('loaded: '+src); res(); };
    s.onerror=()=>{ log('FAIL load: '+src); rej(new Error('Не загрузился '+src)); };
    document.head.appendChild(s);
  });
}
async function ensureHands(){
  if(window.Hands && (window.Hands.Hands||window.Hands)) return;
  log('loading libs…');
  await loadScript('https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js');
  await loadScript('https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js');
}

/* ===== Camera + Hands ===== */
async function startCamera(){
  log('<b>click:</b> Запустить камеру');
  try{
    await ensureHands();
    const HandsCtor = (window.Hands && window.Hands.Hands) || window.Hands;
    if(!HandsCtor) throw new Error('Hands недоступен');

    hands = new HandsCtor({ locateFile: (f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
    const quality = qualitySel.value;
    hands.setOptions({
      maxNumHands:1, selfieMode:true,
      modelComplexity: (quality==='quality'?1:0),
      minDetectionConfidence:0.5, minTrackingConfidence:0.5
    });
    hands.onResults(onHands);

    const camW = (quality==='quality')? 960 : (quality==='balanced'? 720 : 640);
    const camH = 540;

    // getUserMedia (надёжно для Safari по клику)
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:'user', width:{ideal:camW}, height:{ideal:camH} },
      audio:false
    });
    video.srcObject=stream; await video.play();

    // обработка кадров
    const tick = async ()=>{
      await hands.send({image:video});
      trCount++;
      const now=performance.now();
      if(now-lastTR>500){ trackFPS=(trCount*1000)/(now-lastTR); trCount=0; lastTR=now; }
      requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);

    status('Камера: ок');
    if(showDbg.checked){ video.style.display='block'; dbg.style.display='block'; }
  }catch(err){
    showDiag('Камеру получить не удалось: '+(err.message||err));
  }
}

/* ===== Hand results ===== */
function onHands(res){
  // рисуем превью в dbg при необходимости
  if(showDbg.checked){
    try{
      dbgCtx.save();
      dbgCtx.scale(-1,1); // зеркалим как фронтальная камера
      dbgCtx.drawImage(video, -dbg.width, 0, dbg.width, dbg.height);
      dbgCtx.restore();
    }catch(e){}
  }

  if(!res.multiHandLandmarks || !res.multiHandLandmarks.length){
    pointer.pinch=false; return;
  }
  const lm = res.multiHandLandmarks[0];
  const idx = lm[8]; const th = lm[4]; const wrist = lm[0]; const idxMCP = lm[5];

  // нормированные координаты 0..1 (с зеркалом по X при необходимости)
  const rawX = mirrorX.checked ? (1 - idx.x) : idx.x;
  const rawY = idx.y;

  // EMA сглаживание
  const k = (smoothRange.value|0)/100; // 0..0.95
  pointer.rawX = rawX*(1-k) + pointer.rawX*k;
  pointer.rawY = rawY*(1-k) + pointer.rawY*k;

  // Пинч (с гистерезисом)
  const palm = Math.hypot(idxMCP.x - wrist.x, idxMCP.y - wrist.y) + 1e-6;
  const d = Math.hypot(idx.x - th.x, idx.y - th.y) / palm;
  const base = (pinchRange.value|0)/1000; // 0.02..0.2
  const onT = base, offT = base*1.6;
  const prev = pointer.pinch;
  if(!prev && d < onT) pointer.pinch = true;
  if(prev && d > offT) pointer.pinch = false;
  pointer.pinchDown = (!prev && pointer.pinch);
  pointer.pinchUp   = (prev && !pointer.pinch);
}

/* ===== Render loop ===== */
function loop(){
  requestAnimationFrame(loop);
  const now=performance.now(); const dt=now-lastT; lastT=now; rfCount++;
  if(now-lastRF>500){ renderFPS=(rfCount*1000)/(now-lastRF); rfCount=0; lastRF=now; }

  ctx.clearRect(0,0,W,H);
  drawGrid();

  // курсор
  pointer.x = lerp(pointer.x, pointer.rawX, 0.6);
  pointer.y = lerp(pointer.y, pointer.rawY, 0.6);
  const cx = pointer.x*W, cy = pointer.y*H;
  cursor.style.left=cx+'px'; cursor.style.top=cy+'px';
  cursor.classList.toggle('pinching', pointer.pinch);

  // HUD
  fpsEl.textContent = `render: ${renderFPS.toFixed(0)} fps • track: ${trackFPS.toFixed(0)} fps`;
  drawHUD(`Пинч: ${pointer.pinch?'✅':'❌'}`, 'Щипок = клик. Кнопка «Запустить камеру» — по желанию.');

  // очистка «событий кадра»
  pointer.pinchDown=false; pointer.pinchUp=false;
}
function drawGrid(){
  ctx.save(); ctx.strokeStyle='#102033'; ctx.lineWidth=1; const step=40;
  for(let y=0;y<H;y+=step){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }
  for(let x=0;x<W;x+=step){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
  ctx.restore();
}
function addRipple(x,y){
  const d=document.createElement('div'); d.className='ripple'; d.style.left=x+'px'; d.style.top=y+'px';
  document.body.appendChild(d); setTimeout(()=>d.remove(), 520);
}

/* kick off */
resize(); loop(); log('boot complete');

/* safety */
window.addEventListener('error', e=> showDiag('JS ошибка: '+(e.message||'')));
window.addEventListener('unhandledrejection', e=> showDiag('Promise отклонён: '+(e.reason && (e.reason.message||e.reason))));
</script>
</body>
</html>
